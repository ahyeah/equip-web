using System;
using System.Collections.Generic;
using System.Linq;
using System.Web;
using System.Web.Mvc;
using EquipBLL.AdminManagment.MenuConfig;
using EquipBLL.AdminManagment;
using EquipModel.Entities;
using Newtonsoft.Json;
using Newtonsoft.Json.Linq;
using FlowEngine;
using FlowEngine.UserInterface;
using EquipModel.Context;
using System.Data.Entity.Core.Objects;
using System.Data.Entity.Infrastructure;
using EquipBLL.AdminManagment;

namespace WebApp.Controllers
{
    public class UserManagerController : Controller
    {
        private SysMenuManagment menuconfig = new SysMenuManagment();
        //
        // GET: /UserManager/
        public ActionResult Index()
        {
            return View();
        }
        public ActionResult AddUser()
        {
            BaseDataManagment DM = new BaseDataManagment();
            List<Role_Info> R_obj = DM.GetAllRoles();
            return View(R_obj);
        }
        public JsonResult List_Depart()
        {

            BaseDataManagment DM = new BaseDataManagment();

            List<TreeListNode> Depart_obj = DM.BuildDepartList();
            return Json(Depart_obj.ToArray());



        }

        public JsonResult List_Speciaties()
        {
            BaseDataManagment DM = new BaseDataManagment();
            List<TreeListNode> Speciaty_obj = DM.BuildSpeciatyList();
            return Json(Speciaty_obj.ToArray());
        }

        public JsonResult List_Menus(int Role_Id)
        {
            BaseDataManagment DM = new BaseDataManagment();
            List<Menu> Menu_obj = DM.GetRole_Menus(Role_Id);
            List<object> r = new List<object>();
            foreach (Menu item in Menu_obj)
            {
                object o = new
                {
                    Menu_Id = item.Menu_Id,
                    Menu_Name = item.Menu_Name,

                };
                r.Add(o);

            }

            return Json(r.ToArray());

        }

        public JsonResult List_MenuTree(int Role_Id)
        {
            BaseDataManagment DM = new BaseDataManagment();

            List<TreeListNode> Menu_obj = DM.BuildMenuList(Role_Id);
            return Json(Menu_obj.ToArray());


        }
        public string submitNewUser(string json1)
        {
        
            try
            {  PersonManagment PM=new PersonManagment();
                Person_Info newP=new Person_Info();
                JObject item = (JObject)JsonConvert.DeserializeObject(json1);
                newP.Person_Name= item["UserName"].ToString();
                newP.Person_tel= item["UserTel"].ToString();
                newP.Person_mail=item["UserMail"].ToString();
                var roleStr = item["UserRole"].ToString();
                var speciatyStr = item["UserSpeciatySel"].ToString();
                var MenuStr = item["UserMenus"].ToString();

                int Depart_id = Convert.ToInt32(item["UserDepartId"].ToString());

                List<int> SpeciatyList = new List<int>();
                string[] s = speciatyStr.Split(new char[] { ',' });
                for (int i = 0; i < s.Length;i++ )
                { SpeciatyList.Add(Convert.ToInt32(s[i]));}

                List<int> MenuList = new List<int>();
                string[] s1 = MenuStr.Split(new char[] { ',' });
                for (int i = 0; i < s1.Length; i++)
                { MenuList.Add(Convert.ToInt32(s1[i]));}

                int RoleId=Convert.ToInt32(roleStr);

                 PM.Add_Person(newP,Depart_id,RoleId,SpeciatyList,MenuList);  //保存基础信息

                    return "保存成功！";
            }
            catch { return ""; };
	}
    }
}