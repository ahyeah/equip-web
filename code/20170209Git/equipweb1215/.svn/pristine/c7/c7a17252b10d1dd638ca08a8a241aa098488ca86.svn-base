@Model  List<EquipModel.Entities.Role_Info>
    @{
        ViewBag.Title = "AddUser";
        Layout = "~/Views/Shared/_LayoutMain.cshtml";
    }

    <section class="content" style="background-color: #ecf0f5;">
        <div class="row">
            <div class="col-md-12">
                <!-- general form elements -->
                <div class="box box-primary">
                    <div class="box-header with-border">
                        <h3 class="box-title">
                            填写用户基本信息
                        </h3>
                    </div>
                    <!-- /.box-header -->
                    <!-- form start -->
                    <form class="form-horizontal" role="form">

                        <!-- 用户姓名 -->
                        <div class="form-group">
                            <label class="col-sm-2 control-label">用户姓名</label>
                            <div class="col-sm-10">
                                <div class="input-group">
                                    <div class="input-group-addon">
                                        <i class="fa fa-clock-o"></i>
                                    </div>
                                    <input type="text" class="form-control" id="UserName">
                                </div>
                                <!-- /.input group -->
                            </div>
                        </div>
                        <!-- 用户密码 -->
                        <div class="form-group">
                            <label class="col-sm-2 control-label">用户密码</label>
                            <div class="col-sm-10">
                                <div class="input-group">
                                    <div class="input-group-addon">
                                        <i class="fa fa-clock-o"></i>
                                    </div>
                                    <input class="form-control" type="password" placeholder="密码" id="UserPwd">
                                </div>
                                <!-- /.input group -->
                            </div>
                        </div>
                        <!-- 用户部门 -->
                        <div class="form-group">
                            <label class="col-sm-2 control-label">用户部门</label>
                            <div class="col-sm-10">

                                <div class="input-group">
                                    <div class="input-group-addon">
                                        <i class="fa fa-clock-o"></i>
                                    </div>
                                    <input id="UserDepart" data-toggle="modal" data-target="#depart" type="text" class="form-control" onclick="Depart_List()" onfocus=this.blur()>
                                    <input id="UserDepartId" hidden="hidden" />
                                </div>
                                <!-- /.input group -->
                            </div>
                        </div>
                        <!-- 用户专业分类 -->
                        <div class="form-group">
                            <label class="col-sm-2 control-label">专业分类</label>
                            <div class="col-sm-10">
                                <div class="input-group">
                                    <div class="input-group-addon">
                                        <i class="fa fa-clock-o"></i>
                                    </div>
                                    <input id="UserSpecialty" data-toggle="modal" data-target="#speciaty" type="text" class="form-control" onclick="Speciaty_List()" onfocus=this.blur()>
                                    <input id="UserSpecialty_Id" type="text" hidden="hidden" />
                                    <div class="modal-body" id="UserSpeciaty_div" hidden="hidden">




                                    </div> 
                                </div>
                                <!-- /.input group -->
                            </div>
                        </div>

                        <!-- 用户邮箱 -->
                        <div class="form-group">
                            <label class="col-sm-2 control-label">用户邮箱</label>
                            <div class="col-sm-10">
                                <div class="input-group">
                                    <div class="input-group-addon">
                                        <i class="fa fa-clock-o"></i>
                                    </div>
                                    <input type="text" class="form-control" id="UserMail">
                                </div>
                                <!-- /.input group -->
                            </div>
                        </div>
                        <!-- 用户电话 -->
                        <div class="form-group">
                            <label class="col-sm-2 control-label">用户电话</label>
                            <div class="col-sm-10">
                                <div class="input-group">
                                    <div class="input-group-addon">
                                        <i class="fa fa-clock-o"></i>
                                    </div>
                                    <input type="text" class="form-control" id="UserTel">
                                </div>
                                <!-- /.input group -->
                            </div>
                        </div>

                    </form>




                </div>

                <div class="box box-primary">
                    <div class="box-header with-border">
                        <h3 class="box-title">
                            设置用户角色和权限
                        </h3>
                    </div>
                    <!-- /.box-header -->
                    <!-- form start -->
                    <form class="form-horizontal" role="form">

                        <!-- 用户角色选择 -->
                        <div class="form-group">
                            <label class="col-sm-2 control-label">用户角色</label>
                            <div class="col-sm-10">
                                <div class="input-group">
                                    <div class="input-group-addon">
                                        <i class="fa fa-clock-o"></i>
                                    </div>
                                    <select class="form-control select2" style="width: 100%;" id="UserRole" onchange="list_SysMenu()">
                                        <option value="">请选择用户角色</option>
                                        @if (Model != null)
                                        {
                                            foreach (var item in Model)
                                            {
                                                <option value="@item.Role_Id">@item.Role_Name</option>
                                            }
                                        }
                                    </select>
                                </div>
                                <!-- /.input group -->
                            </div>
                        </div>
                        <!-- 用户系统权限选择 -->
                        <div class="form-group">
                            <label class="col-sm-2 control-label">用户权限</label>
                            <div class="col-sm-10">
                                <div class="input-group">
                                    <div class="input-group-addon">
                                        <i class="fa fa-clock-o"></i>
                                    </div>
                                    <input type="text"  id="UserMenu_Id" hidden="hidden" />
                                    <div class="modal-body" id="UserMenu_div">

                                       


                                    </div> 
                                   
                                </div>
                                <!-- /.input group -->
                            </div>
                          
                        </div>
                        <div class="form-group">
                            <div class="col-sm-offset-2 col-sm-10">
                                <button class="btn btn-default" type="button" onclick="submit_click()">提交</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
    </section>
    <!--以下分别为部分、专业选择的模态框-->
    <!--部门模态框开始处-->
    <div class="modal fade" id="depart">
        <div class="modal-dialog ">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">部门选择</h4>
                </div>
                <div class="modal-body">

                    <div id="treeview1"></div>


                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-warning" data-dismiss="modal" onclick="confirmDepart()">确认</button>
                    <button type="button" class="btn btn-primary" data-dismiss="modal">取消</button>
                </div>
            </div>

        </div>

    </div><!--部门模态框结束处-->
    <!--专业模态框开始处-->
    <div class="modal fade" id="speciaty">
        <div class="modal-dialog ">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">专业选择</h4>
                </div>
                <div class="modal-body">

                    <div id="treeview2"></div>


                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-warning" data-dismiss="modal" onclick="confirmSpeciaty()">确认</button>
                    <button type="button" class="btn btn-primary" data-dismiss="modal">取消</button>
                </div>
            </div>

        </div>

    </div><!--专业模态框结束处-->


              
   <!--系统菜单模态框开始处-->
                <div class="modal fade" id="RoleMenu_modal">
                    <div class="modal-dialog ">
                        <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                                <h4 class="modal-title">系统权限选择</h4>
                            </div>
                            <div class="modal-body">

                                <div id="treeview3"></div>


                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-warning" data-dismiss="modal" onclick="Comfirm_ModifySYSM()">确认</button>
                                <button type="button" class="btn btn-primary" data-dismiss="modal">取消</button>
                            </div>
                        </div>

                    </div>

                </div><!--系统菜单模态框结束处-->
    @section js{
        <!-- Page script -->
        <link href="~/Plugins/AdminLTE/plugins/bootstrap-treeview/bootstrap-treeview.min.css" rel="stylesheet" />
        <script src="~/Plugins/AdminLTE/plugins/bootstrap-treeview/bootstrap-treeview.min.js"></script>
        <script type="text/javascript">
            var defaultData = [{
                text: '财务部',

                selectable: false, //设置此节点不可选，这是父节点，财务部
                nodes: [{
                    text: '张三'
                }, {
                    text: '李四'
                }]
            },


                {
                    text: '会计部',
                    selectable: false, //设置此节点不可选，这是父节点，会计部
                    nodes: [{
                        text: '王五'
                    }, {
                        text: '赵六'
                    }]
                },

                {
                    text: '工程部',
                    selectable: false,//设置此节点不可选，这是父节点，工程部
                    nodes: [{
                        text: '孙七'
                    }, {
                        text: '周八'
                    }]
                }

            ];

            //Treeinit()在两个组长、组员的input框被点击是触发，tree初始化
            function Treeinit() {

                $('#treeview1').treeview({
                    data: defaultData,

                });

                $('#treeview2').treeview({
                    data: defaultData,
                    multiSelect: true,//多选的设置
                });


                //初始显示时折叠父节点
                $('#treeview1').treeview('collapseAll', {
                    silent: true
                });

                $('#treeview2').treeview('collapseAll', {
                    silent: true
                });
            };

            //确认部门的选择
            function confirmDepart() {

                var test = $('#treeview1').treeview('getSelected', 1);
                if (test[0].text.indexOf("装置")>-1) {
                    $('#UserSpecialty').val("全部");
                    $('#UserSpecialty').attr("disabled", "disabled");
                    $('#UserDepart').val(test[0].text);
                    $('#UserDepartId').val(test[0].id);
                }
                else {
                    $('#UserDepart').val(test[0].text);
                    $('#UserDepartId').val(test[0].id);
                    $('#UserSpecialty').val("");
                    $('#UserSpecialty').removeAttr("disabled");

                }

            }



            function Depart_List() {
                $.ajax({
                    type: 'POST',
                    url: '/UserManager/List_Depart',
                    dataType: 'json',
                    success: function (defaultData) {
                        $('#treeview1').treeview({
                            data: defaultData,

                        });
                        //初始显示时折叠父节点
                        $('#treeview1').treeview('collapseAll', {
                            silent: true
                        });
                    },
                    error: function () {
                        alert('error');
                    }
                });

            }

            function Speciaty_List() {
                $.ajax({
                    type: 'POST',
                    url: '/UserManager/List_Speciaties',
                    dataType: 'json',
                    success: function (defaultData) {
                        $('#treeview2').treeview({
                            data: defaultData,
                            multiSelect: true,
                        });
                        //初始显示时折叠父节点
                        $('#treeview2').treeview('collapseAll', {
                            silent: true
                        });
                    },
                    error: function () {
                        alert('error');
                    }
                });

            }

            function confirmSpeciaty()
            {
                var test = $('#treeview2').treeview('getSelected', 1);
                $('#UserSpecialty_div').html("");



                var itemHtml = " <select class=\"form-control\" multiple=\"\" id=\"UserSpecialtySel\" disabled=true>";

                var member = "",member2="";
                for (var i = 0; i < test.length; i++) {
                    itemHtml = itemHtml + "<option value=\"" + test[i].id + "\">" + test[i].text + "</option>";
                    if (test[i].text && i < test.length - 1) {
                        member += test[i].text + ',';
                        member2 += test[i].id + ',';
                    }
                    else {
                        member += test[i].text
                        member2 += test[i].id ;
                    }
                }
                itemHtml = itemHtml + "</select>";
                $('#UserSpecialty').val(member);
                $('#UserSpecialty_Id').val(member2);
                $('#UserSpeciaty_div').html(itemHtml);

            }

            function list_SysMenu() {
                $.ajax({
                    type: 'POST',
                    url: '/UserManager/List_Menus',
                    data: { "Role_Id": $("#UserRole").val() },
                    dataType: 'json',
                    success: function (defaultData) {
                        if (defaultData) {
                            var itemHtml = " <select class=\"form-control\" multiple=\"\" id=\"UserMenus\" disabled=true>";

                            var member2=""
                            for (var i = 0; i < defaultData.length; i++) {
                                itemHtml = itemHtml + "<option value=\"" + defaultData[i].Menu_Id + "\">" + defaultData[i].Menu_Name + "</option>";
                                if (i < defaultData.length - 1) { member2 += defaultData[i].Menu_Id + ','; }
                                else member2 += defaultData[i].Menu_Id;

                            }
                            itemHtml = itemHtml + "</select>";
                            itemHtml = itemHtml + "<button  type=\"button\" data-toggle=\"modal\" data-target=\"#RoleMenu_modal\"  class=\"form-control\" onclick=\"Modify_Menus()\"  onfocus=this.blur()> 修改权限 </button>"
                            $('#UserMenu_Id').val(member2);
                            $('#UserMenu_div').html(itemHtml);
                        }





                    },
                    error: function (defaultData) {
                        alert(defaultData.data);
                        alert('error');
                    }
                });
            }
                function Modify_Menus() {
                    $.ajax({
                        type: 'POST',
                        url: '/UserManager/List_MenuTree',
                        data: { "Role_Id": $("#UserRole").val() },
                        dataType: 'json',
                        success: function (defaultData) {
                            $('#treeview3').treeview({
                                data: defaultData,
                                multiSelect: true,
                            });

                        },
                        error: function () {
                            alert('error');
                        }
                    });

                }
          
                function Comfirm_ModifySYSM()
                {  
                    var test = $('#treeview3').treeview('getSelected', 1);
                    $('#UserMenu_div').html("");

                   

                    var itemHtml = " <select class=\"form-control\" multiple=\"\" id=\"UserMenus\" disabled=true>";

                    var member2=""
                    for (var i = 0; i < test.length; i++) {
                        itemHtml = itemHtml + "<option value=\"" + test[i].id + "\">" + test[i].text + "</option>";
                        if (i < test.length - 1) { member2 += test[i].id + ','; }
                        else member2 += test[i].id;


                    }
                    itemHtml = itemHtml + "</select>";
                    itemHtml = itemHtml + "<button  type=\"button\" data-toggle=\"modal\" data-target=\"#RoleMenu_modal\"  class=\"form-control\" onclick=\"Modify_Menus()\"  onfocus=this.blur()> 修改权限 </button>"
                    alert(member2);
                    $('#UserMenu_Id').val(member2);
                    $('#UserMenu_div').html(itemHtml);
                }

                function submit_click()
                {
                    
                    $.ajax({
                        type: 'POST',
                        url: '/UserManager/submitNewUser',
                       data: {
                            json1: '{UserName: "' + $('#UserName').val()
                                 + '", UserPwd: "' + $('#UserPwd').val()
                                 + '", UserDepartId: "' + $('#UserDepartId').val()
                                 + '", UserMail: "' + $('#UserMail').val()
                                 + '", UserTel: "' + $('#UserTel').val()
                                 + '", UserSpeciatySel: "' + $('#UserSpecialty_Id').val()
                                 + '", UserRole: "' + $('#UserRole').val()
                                 + '", UserMenus: "' + $('#UserMenu_Id').val()
                                 + '"}'
                        },
                       success: function (data) {
                            alert( data);
                        },
                        error: function () {
                            alert('error');
                        }
                    });


                }
        </script>
    }
