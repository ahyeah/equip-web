using EquipModel.Entities;
using FlowEngine;
using FlowEngine.UserInterface;
using WebApp.Models;
using WebApp.Models.User;
using System;
using System.Collections.Generic;
using System.Data.Entity.Infrastructure;
using System.Linq;
using System.Web;
using System.Web.Mvc;
using Newtonsoft.Json.Linq;
using Newtonsoft.Json;
using EquipModel.Context;
using System.Text;
using EquipBLL.AdminManagment;
using System.IO;
using FlowEngine.Modals;
using FlowEngine.DAL;
using System.Xml;
using FlowEngine.Event;

namespace WebApp.Controllers
{
    public class CommonController : Controller
    {
        //Page Models
        public class MainModel
        {
            public string userName;
            public string missTime;
            public int missIndex;
            public string miss_desc;
            public string miss_url;
            public string wfe_serial;
        }

        public class HistroyModel
        {
            public int miss_wfe_Id;
            public string missStartName;
            public string missStartTime;
            public int missIndex;
            public string miss_LastStatusdesc;
            public string wfe_serial;
        }

        public class Index_Model
        {
            public List<MainModel> Am;
            public List<HistroyModel> Hm;
        }

        public class MissInfoModel
        {
            public UI_MISSION miModel;
            public List<string> MissTime;
            public List<string> MissUser;
        }

        public class WFDetail_Model
        {
            public List<UI_MISSION> ALLHistoryMiss;
            public List<string> MissTime;
            public List<string> MissUser;
        }

        public class ZzSubmitModel
        {
            public string UserName;
            public string UserDepartment;
            public List<Equip_Archi> UserHasEquips;
        }
        //A5_ModelInfo
        public class A5_ModelInfo
        {
            public string Pq_Name;
            public string Zz_Name;
            public string Equip_Code;
            public string Equip_GyCode;
            public int nTimesInMonth;
            public int nTimesInYear;
            public int nFlagTheWorstTen;//是否列入最差或最脏10台? 0-否，1-是
        }
        //A5_Model
        public class A5_Model
        {
            public List<A5_ModelInfo> A5_ModelInfoList;
        }
        //Risk Matrix
        public class RiskMatrixElement
        {
            public int danger_intensity;
            public int time_level;
            public string color;
            public string DangerType_isgreen;
        }

        public class MissHisLinkModal
        {
            public int Miss_Id;
            public string Miss_Name;
            public string Miss_Time;
            public int Miss_Type;  //0：一般任务  1：子流程任务
            public string Miss_LinkFlowType;//"Normal" ，"paradel","Serial"
            public int Miss_LinkFlowId;//跳转的工作流Id
        }

        public class ListMissHisLInkModal
        {
            public int Flow_Id;
            public string Flow_Name;
            public List<MissHisLinkModal> Miss;
        }

        public JsonResult WorkFlow_MainProcess(string Entity_Ser)
        {
            // System.Data.DataTable dt = CWFEngine.QueryAllInformation("M.Miss_Name", "E.WE_Ser='20160200006'", "1<>1");
            List<UI_MISSION> miss;
            ListMissHisLInkModal missModals = new ListMissHisLInkModal();
            missModals.Miss = new List<MissHisLinkModal>();
            UI_WFEntity_Info wfe = CWFEngine.GetMainWorkFlowEntity(Entity_Ser);
            missModals.Flow_Id = wfe.EntityID;
            missModals.Flow_Name = wfe.name;
            miss = CWFEngine.GetHistoryMissions(wfe.EntityID);
            if (wfe.Status == WE_STATUS.ACTIVE)
            {
                miss.Add(CWFEngine.GetActiveMission<Person_Info>(wfe.EntityID, null, false));
            }
            WorkFlows wfs = new WorkFlows();
            WorkFlow_Entity wfe2 = wfs.GetWorkFlowEntity(wfe.EntityID);
            CWorkFlow wf = new CWorkFlow();
            XmlDocument doc = new XmlDocument();
            doc.LoadXml(Encoding.Default.GetString(wfe2.WE_Binary));
            wf.InstFromXmlNode(doc.DocumentElement);
            wf.EntityID = wfe.EntityID;
            IDictionary<string, IEvent> allEvents = wf.events;
            foreach (var item in miss)
            {

                MissHisLinkModal m = new MissHisLinkModal();
                m.Miss_Id = item.Miss_Id;
                m.Miss_Name = item.WE_Event_Desc;
                if (item.Miss_Id > 0)
                {
                    IDictionary<string, string> r = CWFEngine.GetMissionRecordInfo(item.Miss_Id);
                    if (r.Count > 0)
                    {
                        m.Miss_Time = r["time"];
                    }
                    else
                    {
                        m.Miss_Time = "";
                    }
                }
                else
                {
                    m.Miss_Time = "";
                }
                if (allEvents[item.WE_Event_Name].GetType().Name == "CSubProcessEvent")
                {
                    m.Miss_Type = 1;
                    m.Miss_LinkFlowType = ((CSubProcessEvent)allEvents[item.WE_Event_Name]).WorkingMode;
                    m.Miss_LinkFlowId = ((CSubProcessEvent)allEvents[item.WE_Event_Name]).WfEntityId;
                }
                else
                {
                    m.Miss_Type = 0;
                    m.Miss_LinkFlowType = "Normal";
                    m.Miss_LinkFlowId = -1;
                }

                missModals.Miss.Add(m);
            }

            return Json(missModals);
        }


        public JsonResult WorkFlow_ListParam(string json1)
        {
            JObject item = (JObject)JsonConvert.DeserializeObject(json1);

            int Flow_Id = Convert.ToInt32(item["Entity_Id"].ToString());
            int Mission_Id = Convert.ToInt32(item["Mission_Id"].ToString());
            List<UI_MissParam> MissParams = CWFEngine.GetMissionParams(Flow_Id, Mission_Id);
            return Json(MissParams.ToArray());


        }

        public JsonResult WorkFlow_SubProcess(int FlowId)
        {
            List<UI_MISSION> miss;
            ListMissHisLInkModal missModals = new ListMissHisLInkModal();
            missModals.Miss = new List<MissHisLinkModal>();
            UI_WFEntity_Info wfe = CWFEngine.GetWorkFlowEntiy(FlowId, true);
            missModals.Flow_Id = FlowId;
            missModals.Flow_Name = wfe.name;
            miss = CWFEngine.GetHistoryMissions(wfe.EntityID);
            if (wfe.Status == WE_STATUS.ACTIVE)
            {
                miss.Add(CWFEngine.GetActiveMission<Person_Info>(wfe.EntityID, null, false));
            }
            WorkFlows wfs = new WorkFlows();
            WorkFlow_Entity wfe2 = wfs.GetWorkFlowEntity(wfe.EntityID);
            CWorkFlow wf = new CWorkFlow();
            XmlDocument doc = new XmlDocument();
            doc.LoadXml(Encoding.Default.GetString(wfe2.WE_Binary));
            wf.InstFromXmlNode(doc.DocumentElement);
            wf.EntityID = wfe.EntityID;
            IDictionary<string, IEvent> allEvents = wf.events;
            foreach (var item in miss)
            {

                MissHisLinkModal m = new MissHisLinkModal();
                m.Miss_Id = item.Miss_Id;
                m.Miss_Name = item.WE_Event_Desc;
                if (item.Miss_Id > 0)
                {
                    IDictionary<string, string> r = CWFEngine.GetMissionRecordInfo(item.Miss_Id);
                    if (r.Count > 0)
                    {
                        m.Miss_Time = r["time"];
                    }
                    else
                    {
                        m.Miss_Time = "";
                    }
                }
                else
                {
                    m.Miss_Time = "";
                }
                if (allEvents[item.WE_Event_Name].GetType().Name == "CSubProcessEvent")
                {
                    m.Miss_Type = 1;
                    m.Miss_LinkFlowType = ((CSubProcessEvent)allEvents[item.WE_Event_Name]).WorkingMode;
                    m.Miss_LinkFlowId = ((CSubProcessEvent)allEvents[item.WE_Event_Name]).WfEntityId;
                }
                else
                {
                    m.Miss_Type = 0;
                    m.Miss_LinkFlowType = "Normal";
                    m.Miss_LinkFlowId = -1;
                }

                missModals.Miss.Add(m);
            }
            return Json(missModals);

        }
        //Page BLL Codes
        /// <summary>
        /// 获取工作流Index页面的列表记录
        /// </summary>
        /// <param name="WorkFlow_Name">工作流名称，如A8dot2</param>
        /// <param name="username">用户名</param>
        /// <returns></returns>
        /// 




        public Index_Model getIndexListRecords(string WorkFlow_Name, string username)
        {
            List<UI_MISSION> miss;
            //miss = CWFEngine.GetActiveMissions<Person_Info>(((IObjectContextAdapter)(new EquipWebContext())).ObjectContext);
            miss = CWFEngine.GetActiveMissions<Person_Info>(((IObjectContextAdapter)(new EquipWebContext())).ObjectContext, WorkFlow_Name, true);
            Index_Model listRecord = new Index_Model();
            listRecord.Am = new List<MainModel>();
            foreach (var item in miss)
            {
                MainModel o = new MainModel();
                UI_MISSION lastMi = CWFEngine.GetHistoryMissions(item.WE_Entity_Id).Last();
                int Miss_Id = lastMi.Miss_Id;
                IDictionary<string, string> r = CWFEngine.GetMissionRecordInfo(Miss_Id);
                if (r.Count > 0)
                {
                    o.userName = r["username"];
                    o.missTime = r["time"];
                }
                else
                {
                    o.userName = "";
                    o.missTime = "";
                }
                o.missIndex = miss.IndexOf(item) + 1;
                o.miss_desc = item.WE_Event_Desc;
                o.miss_url = item.Mission_Url;
                //
                //List<UI_WFEntity_Info> current_entitie = CWFEngine.GetWFEntityByHistoryStatus(t => t.Miss_WFentity.WE_Id== item.WE_Entity_Id);
                //o.wfe_serial = current_entitie[0].serial;
                o.wfe_serial = lastMi.WE_Entity_Ser;
                listRecord.Am.Add(o);
            }
            listRecord.Hm = new List<HistroyModel>();
            HistroyModel h;
            List<UI_WFEntity_Info> start_entities = CWFEngine.GetWFEntityByHistoryDone(t => t.Record_Info.Count(q => q.Re_Name == "username" && q.Re_Value == username) > 0 && t.Miss_WFentity.WE_Wref.W_Name == WorkFlow_Name);
            foreach (var item in start_entities)
            {
                h = new HistroyModel();
                List<UI_MISSION> AllHistoryMiss = CWFEngine.GetHistoryMissions(item.EntityID);
                int Miss_Id = AllHistoryMiss[0].Miss_Id;
                IDictionary<string, string> r = CWFEngine.GetMissionRecordInfo(Miss_Id);
                if (r.Count > 0)
                {
                    h.missStartName = r["username"];
                    h.missStartTime = r["time"];
                }
                else
                {
                    h.missStartName = "";
                    h.missStartTime = "";
                }
                h.missIndex = start_entities.IndexOf(item) + 1;
                h.wfe_serial = item.Binary;
                UI_MISSION miss_last = AllHistoryMiss[AllHistoryMiss.Count() - 1];

                h.miss_LastStatusdesc = miss_last.WE_Event_Desc;
                h.miss_wfe_Id = item.EntityID;
                listRecord.Hm.Add(h);
            }
            return listRecord;
        }

        public JsonResult Cj_Zzs(int cj_id)
        {
            EquipManagment pm = new EquipManagment();
            List<Equip_Archi> Zz = pm.getZzs_ofCj(cj_id);
            List<object> Zz_obj = new List<object>();
            foreach (var item in Zz)
            {
                object o = new
                {
                    Zz_Id = item.EA_Id,
                    Zz_Name = item.EA_Name
                };
                Zz_obj.Add(o);

            }
            return Json(Zz_obj.ToArray());

        }

        public JsonResult Zz_Equips(int Zz_id)
        {
            EquipManagment pm = new EquipManagment();
            List<Equip_Info> Equips_of_Zz = pm.getEquips_OfZz(Zz_id);
            List<object> Equip_obj = new List<object>();
            foreach (var item in Equips_of_Zz)
            {
                object o = new
                {
                    Equip_Id = item.Equip_Id,
                    Equip_GyCode = item.Equip_GyCode,
                    // Equip_Code=item.Equip_Code,
                    //  Equip_Type=item.Equip_Type,
                    // Equip_Specialty=item.Equip_Specialty
                };
                Equip_obj.Add(o);
            }
            return Json(Equip_obj.ToArray());

        }

        public JsonResult ListEquip_Info(int Equip_Id)
        {
            EquipManagment pm = new EquipManagment();
            Equip_Info EquipInfo_selected = pm.getEquip_Info(Equip_Id);
            List<object> Equip_obj = new List<object>();

            object o = new
            {
                Equip_Code = EquipInfo_selected.Equip_Code,
                Equip_Type = EquipInfo_selected.Equip_Type,
                Equip_Specialty = EquipInfo_selected.Equip_Specialty,
                Equip_PhaseB = EquipInfo_selected.Equip_PhaseB
            };
            Equip_obj.Add(o);
            return Json(Equip_obj.ToArray());

        }

        /// <summary>
        /// 
        /// </summary>
        /// <param name="wfe_id"></param>
        /// <returns></returns>
        public ZzSubmitModel getSubmitModel(string wfe_id)
        {
            PersonManagment pm = new PersonManagment();
            ZzSubmitModel mm = new ZzSubmitModel();
            ViewBag.WF_NAME = wfe_id;
            mm.UserName = (Session["User"] as EquipModel.Entities.Person_Info).Person_Name;
            mm.UserDepartment = pm.Get_Person_DepartOfParent((Session["User"] as EquipModel.Entities.Person_Info).Person_Id).Depart_Name;
            mm.UserHasEquips = pm.Get_Person_Cj((Session["User"] as EquipModel.Entities.Person_Info).Person_Id);
            ViewBag.curtime = DateTime.Now.ToString();
            ViewBag.curuser = mm.UserName;
            return mm;
        }

        /// <summary>
        /// 
        /// </summary>
        /// <param name="wfe_id"></param>
        /// <returns></returns>
        public MissInfoModel getMissInfoModel(string wfe_id)
        {
            MissInfoModel cm = new MissInfoModel();
            ViewBag.WF_NAME = wfe_id;
            cm.miModel = CWFEngine.GetActiveMission<Person_Info>(int.Parse(wfe_id), ((IObjectContextAdapter)(new EquipWebContext())).ObjectContext);
            cm.MissTime = new List<string>();
            cm.MissUser = new List<string>();
            string t;
            foreach (var item in CWFEngine.GetHistoryMissions(cm.miModel.WE_Entity_Id))
            {
                IDictionary<string, string> r = CWFEngine.GetMissionRecordInfo(item.Miss_Id);
                t = r["username"];
                cm.MissUser.Add(t);
                t = r["time"];
                cm.MissTime.Add(t);
            }
            ViewBag.curtime = DateTime.Now.ToString();
            ViewBag.curuser = (Session["User"] as EquipModel.Entities.Person_Info).Person_Name;
            return cm;
        }

        /// <summary>
        /// 
        /// </summary>
        /// <param name="wfe_id"></param>
        /// <returns></returns>
        public WFDetail_Model getWFDetail_Model(string wfe_id)
        {
            WFDetail_Model cm = new WFDetail_Model();
            ViewBag.WF_NAME = wfe_id;
            cm.ALLHistoryMiss = CWFEngine.GetHistoryMissions(int.Parse(wfe_id));
            ViewBag.WF_Ser = cm.ALLHistoryMiss[0].WE_Entity_Ser;
            cm.MissTime = new List<string>();
            cm.MissUser = new List<string>();
            string t;
            foreach (var item in cm.ALLHistoryMiss)
            {
                IDictionary<string, string> r = CWFEngine.GetMissionRecordInfo(item.Miss_Id);
                if (r.Count > 0)
                {
                    t = r["username"];
                    cm.MissUser.Add(t);
                    t = r["time"];
                    cm.MissTime.Add(t);
                }
                else
                {
                    cm.MissUser.Add("");
                    cm.MissTime.Add("");
                }
            }
            ViewBag.curtime = DateTime.Now.ToString();
            ViewBag.curuser = (Session["User"] as EquipModel.Entities.Person_Info).Person_Name;
            return cm;
        }

        /// <summary>
        /// 
        /// </summary>
        /// <param name="typeA5">A5dot1或A5dot2</param>
        /// <returns></returns>
        public A5_Model getA5_Model(string WorkFlow_Name_Of_A5)
        {
            A5_Model A5model=new A5_Model();
            A5model.A5_ModelInfoList = new List<A5_ModelInfo>();
            A5_ModelInfo h;
            List<UI_WFEntity_Info> start_entities = CWFEngine.GetWFEntityByHistoryDone(t => t.Miss_WFentity.WE_Wref.W_Name == WorkFlow_Name_Of_A5);
            foreach (var item in start_entities)
            {
                h = new A5_ModelInfo();
                List<UI_MISSION> AllHistoryMiss = CWFEngine.GetHistoryMissions(item.EntityID);
                int Miss_Id = AllHistoryMiss[0].Miss_Id;                
                if (AllHistoryMiss.Count > 2)
                {
                    h.Pq_Name = AllHistoryMiss[1].Miss_Params["Cj_Name"].ToString();
                    h.Zz_Name = AllHistoryMiss[1].Miss_Params["Zz_Name"].ToString();
                    h.Equip_Code = AllHistoryMiss[1].Miss_Params["Equip_Code"].ToString();
                    h.Equip_GyCode = AllHistoryMiss[1].Miss_Params["Equip_GyCode"].ToString();
                    h.nTimesInMonth = 2;
                    h.nTimesInYear=3;
                    h.nFlagTheWorstTen=0;
                    A5model.A5_ModelInfoList.Add(h);
                }
                else
                {        
                }
                                
            }
            return A5model;
        }

        //[HttpPost]
        //public JsonResult Upload(HttpPostedFileBase file)
        //{

        //    if (file.ContentLength == 0)
        //    {
        //        return Json(new { message = "没有文件" });
        //    }
        //    var fileName = Path.Combine(Request.MapPath("~/Upload"), Path.GetFileName(file.FileName));
        //    try
        //    {
        //        file.SaveAs(fileName);
        //        var FileSize = (file.ContentLength * 1.0 / 1024).ToString("0.00");
        //        Dictionary<string, string> r = new Dictionary<string, string>();
        //        r.Add("message", "上传成功");
        //        r.Add("fileName", file.FileName);
        //        r.Add("fileSize", FileSize);
        //        return Json(r);
        //    }
        //    catch
        //    {
        //        return Json(new { message = "上传失败" });
        //    }
        //}

        //public JsonResult DelAttachment(string file)
        //{
        //    try
        //    {
        //        string filePath = Path.Combine(Request.MapPath("~/Upload"), file);
        //        if (System.IO.File.Exists(filePath))
        //        {
        //            System.IO.File.Delete(filePath);
        //            return Json(new { status = "success" });
        //        }
        //        return Json(new { status = "false", message = "附件删除失败!" });
        //    }
        //    catch (Exception ex)
        //    {
        //        return Json(new { status = "false", message = "附件删除失败!" });
        //    }
        //}

        private string getGUID()
        {
            System.Guid guid = new Guid();
            guid = Guid.NewGuid();
            string str = guid.ToString();
            return str;
        }
        [HttpPost]
        public JsonResult Upload(HttpPostedFileBase file)
        {

            if (file.ContentLength == 0)
            {
                return Json(new { message = "没有文件" });
            }
            string savedFileName = getGUID() + Path.GetExtension(file.FileName);
            string uploadFileName = Path.GetFileName(file.FileName);

            string allFileNames = uploadFileName + "$" + savedFileName;
            var fileName = Path.Combine(Request.MapPath("~/Upload"), Path.GetFileName(savedFileName));
            try
            {
                file.SaveAs(fileName);
                var FileSize = (file.ContentLength * 1.0 / 1024).ToString("0.00");
                Dictionary<string, string> r = new Dictionary<string, string>();
                r.Add("message", "上传成功");
                r.Add("fileName", Path.GetFileName(file.FileName));
                r.Add("fileSize", FileSize);
                r.Add("allFileNames", allFileNames);
                return Json(r);
            }
            catch
            {
                return Json(new { message = "上传失败" });
            }
        }

        public JsonResult DelAttachment(string file)
        {
            try
            {
                string[] savedFileName = file.Split(new char[] { '$' });
                string filePath = Path.Combine(Request.MapPath("~/Upload"), savedFileName[1]);
                if (System.IO.File.Exists(filePath))
                {
                    System.IO.File.Delete(filePath);
                    return Json(new { status = "success" });
                }
                return Json(new { status = "false", message = "附件删除失败!" });
            }
            catch (Exception ex)
            {
                return Json(new { status = "false", message = "附件删除失败!" });
            }
        }

        //取消提交，从数据库中删除刚建立的一个工作流实体
        public string CancelSubmit(string json1)
        {
            try
            {
                JObject item = (JObject)JsonConvert.DeserializeObject(json1);
                string wfe_id = item["wef_id"].ToString();
                string return_url = item["return_url"].ToString();
                CWFEngine.RemoveWFEntity(int.Parse(wfe_id));
                return return_url;
            }
            catch (Exception e)
            {
                return "";
            }
        }

       

	}
}