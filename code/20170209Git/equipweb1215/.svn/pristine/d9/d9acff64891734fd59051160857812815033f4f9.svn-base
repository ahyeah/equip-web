@model WebApp.Controllers.CommonController.ZzSubmitModel
@{
    ViewBag.Title = "ZzSubmit";
    Layout = "~/Views/Shared/_LayoutMain.cshtml";
}


<section class="content" style="background-color: #ecf0f5;">
    <div class="row">
        <div class="col-md-12">
                  <!-- The time line -->
            <ul class="timeline">
               <!-- 工作流当前任务-Star -->
                    <!-- timeline item -->
                    <li class="time-label">
                        <span class="bg-green">
                           当前任务：人工提报(特护记录）
                        </span>
                    </li>
                <!-- /.timeline-label -->
                <!-- timeline item -->
                <li>
                    <i class="fa fa-camera bg-purple"></i>
                    <div class="timeline-item">
                        <span class="time"><i class="fa fa-clock-o">@ViewBag.curtime</i>当前用户：@ViewBag.curuser</span>
                        <h3 class="timeline-header"><span class="lead" style="color:red">人工提报(特护记录）</span></h3>
                        <div class="timeline-body">
                        <form class="form-horizontal" role="form" >
                            <input type="text" id="wef_id" hidden="hidden" value="@ViewBag.WF_NAME">  
                            <div class="form-group">
                                    <label class="col-sm-2 control-label">申请车间</label>
                                    <div class="col-sm-10">
                                        <select class="form-control select2" style="width: 100%;" id="cjname" onchange="list_Zz()">
                                            <option value="">请选择</option>
                                            @if (Model.UserHasEquips != null)
                                            {
                                                foreach (var item in Model.UserHasEquips)
                                                {
                                                    <option value="@item.EA_Id">@item.EA_Name</option>
                                                }
                                            }
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-sm-2 control-label">申请装置</label>
                                    <div id="Zz_Select" class="col-sm-10">                                     
                                         <select class="form-control select2" style="width: 100%;" id="zzId" onchange="Zz_selected()" >
                                            <option value="">请选择</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-sm-2 control-label">设备工艺编号</label>
                                    <div id="Equip_Select" class="col-sm-10">
                                        <select class="form-control select2" style="width: 100%;" id="Equip_GyCode" onchange="Equip_selected()" >
                                            <option value="">请选择</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-sm-2 control-label">设备编号</label>
                                    <div class="col-sm-10">
                                        <input type="text" class="form-control" id="E_Code" disabled="">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-sm-2 control-label">设备型号</label>
                                    <div class="col-sm-10">
                                        <input type="text" class="form-control" id="E_Type" disabled="">
                                    </div>
                                </div>
           
                                <div class="form-group">
                                    <label class="col-sm-2 control-label">特护记录</label>
                                    <div id="Thjl_Select" class="col-sm-10">
                                        <select class="form-control select2" style="width: 100%;" id="thjl_id" onchange="Thjl_selected()">
                                            <option value="0">请选择</option>
                                            <option value="1">气压机特护记录</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="form-group" id="thjl">
                                    <label class="col-sm-2 control-label">特护记录信息 </label>
                        
                                    <div id="Thjl_list" class="col-sm-10">
                                        <button class="btn btn-info col-sm-offset-11" type="button" onclick="modify_row()">修改</button>
                                        <table id="thjl_datatable"  width="100%" cellspacing="1">
                                            <thead>
                                                <tr>
                                                    <th>项目</th>
                                                    <th>设计值</th>
                                                    <th>实测值</th>
                                                </tr>
                                            </thead>


                                        </table>
                                        </div>
                          
                                    </div>

                                <div class="form-group">
                                    <label class="col-sm-2 control-label">特护纪要：工作要点记载</label>
                                    <div class="col-sm-10">
                                        <textarea class="form-control" rows="3" id="workdetail"></textarea>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-sm-2 control-label">特护纪要：设备问题记载</label>
                                    <div class="col-sm-4">
                                        <button class="btn btn-info col-sm-offset-0" type="button" onclick="add_row()">增加</button>
                                        <button class="btn btn-info col-sm-offset-1" type="button" onclick="del_row()">删除</button>
                                    </div>


                                </div>

                                <div class="form-group">
                                    <label class="col-sm-2 control-label"></label>
                      
                                    <div class="col-sm-10" id="example_div">
                                        <table id="example" class="table table-striped table-bordered" width="100%" cellspacing="0">
                                            <thead>
                                                <tr>
                                                    <th>问题分类</th>
                                                    <th>问题描述</th>
                                                </tr>
                                            </thead>


                                        </table>
                                        </div>
                                    </div>


@*                                <div class="form-group">
                                    <button class="btn btn-primary col-sm-offset-4" type="button" onclick="submit_click()">确定提交</button>
                                    <button class="btn btn-primary col-sm-offset-2" type="button" onclick="cancel_click()">取消提交</button>
                                </div>*@
                            </form>

                                            
                            <form role="form">   
                           <div class="box-footer">
                                    <button class="btn btn-primary col-sm-offset-2" type="button" onclick="submit_click()">确定提交</button>
                                    <button class="btn btn-primary col-sm-offset-1" type="button" onclick="cancel_click()">取消提交</button>
                           </div>
                            </form>
                        </div>
                    </div>
                </li>
                <!-- END timeline item -->
                <!-- timeline item -->
                <!-- 工作流当前任务-End -->
                </ul>
         </div>
    </div>

</section>

<div class="modal fade" id="thjl_modal" tabindex="-1" role="dialog"
     aria-labelledby="thjl_modal_header" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close"
                        data-dismiss="modal" aria-hidden="true">
                    &times;
                </button>
                <h4 class="modal-title" id="thjl_modal_header">
                    <span id="thjl_name"></span>
                </h4>
            </div>
            <div class="modal-body">             

                <div class="form-group">
                    <label class="col-sm-2 control-label">设计值</label>
                    
                    <div class="col-sm-10">   
                        <input type="text" class="form-control " style="width: 100%;" id="standard_value" readonly>                  
                    </div>
                   
                   
                </div>

                <div class="form-group">
                   
                    <label class="col-sm-2 control-label">实测值</label>
                    <div class="col-sm-10">
                        <input type="text" class="form-control " style="width: 100%;" id="exact_value">
                    </div>

                </div>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default"
                        data-dismiss="modal" >
                    关闭
                </button>
                <button type="button" class="btn btn-primary" onclick="add_thjl_record()">
                    确定
                </button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal -->
    </div>

<div class="modal fade" id="myModal" tabindex="-1" role="dialog"
     aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close"
                        data-dismiss="modal" aria-hidden="true">
                    &times;
                </button>
                <h4 class="modal-title" id="myModalLabel">
                   添加设备问题记录
                </h4>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="checkbox-inline">
                        <input type="radio" name="optionsRadiosinline" id="optionsRadios1"
                               value="动" checked>动
                    </label>
                    <label class="checkbox-inline">
                        <input type="radio" name="optionsRadiosinline" id="optionsRadios2"
                               value="静">静
                    </label>
                    <label class="checkbox-inline">
                        <input type="radio" name="optionsRadiosinline" id="optionsRadios3"
                               value="电">电
                    </label>
                    <label class="checkbox-inline">
                        <input type="radio" name="optionsRadiosinline" id="optionsRadios4"
                               value="仪">仪
                    </label>
                </div>
                <div class="form-group">
                    <label class="col-sm-2 control-label">问题描述</label>
                    <div class="col-sm-10">
                        <textarea class="form-control" rows="2" id="new_problem_desc"></textarea>
                    </div>
                </div>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default"
                        data-dismiss="modal" onclick="cancel_problem_record()">
                    关闭
                </button>
                <button type="button" class="btn btn-primary" onclick="add_problem_record()">
                    确定
                </button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal -->
</div>

@section js{
    <!-- Page script -->
<script src="~/Plugins/AdminLTE/plugins/timepicker/bootstrap-timepicker.min.js"></script>
<script src="~/Scripts/jquery.form.js"></script>   <script src="~/Scripts/myFormValidator.js"></script>
<script src="~/Scripts/dataTables.bootstrap.min.js"></script>
<script src="~/Scripts/jquery.dataTables.min.js"></script>
<script src="~/Scripts/json2.js"></script>
<link rel="stylesheet" type="text/css" href="~/Plugins/jquery.dataTables.min.css" />

  <script>
                $(function () {

                    $('#example').DataTable({
                        paging: false,
                        "searching": false,
                        "info": false,
                        "ordering": false,
                        "columns": [
                            { "data": "problem_catalogy" },
                            { "data": "problem_detail" }
                        ]
                    });
                    /*
                    $('#thjl_datatable').DataTable({
                        paging: false,
                        "searching": false,
                        "info": false
                    });
                    */

                    $('#thjl').hide();
                    $('#example_div').hide();


                    var table = $('#example').DataTable();

                    $('#example tbody').on('click', 'tr', function () {
                        //   alert("ddd");
                        if ($(this).hasClass('selected')) {
                            $(this).removeClass('selected');
                        }
                        else {
                            table.$('tr.selected').removeClass('selected');
                            $(this).addClass('selected');
                        }
                    });
                });

                function add_row() {
                    $('#new_problem_desc').val('');
                    //  $('#optionsRadios1').attr('checked', 'true');
                    $('#myModal').modal('hide');
                    $('#myModal').modal('show');


                }

                function cancel_problem_record() {
                    $('#myModal').modal('hide');
                }

                function add_problem_record() {
                    $('#example_div').show();
                    var new_problem_desc = $('#new_problem_desc').val();
                    var new_problem_category;
                    $('input:radio').each(function () {
                        if ($(this).is(":checked")) {
                            new_problem_category = $(this).val();
                        }
                    });
                    cancel_problem_record();
                    var t = $('#example').DataTable();
                    var obj = { problem_catalogy: new_problem_category, problem_detail: new_problem_desc };
                    t.row.add(obj).draw(false);

                    //  t.row.add([new_problem_category, new_problem_desc]).draw(false);
                }

                function del_row() {
                    var t = $('#example').DataTable();
                    t.row('.selected').remove().draw(false);
                }

                function submit_click() {
                    if (!myValidation())
                        return false;
                    if (!confirm('确定要提交吗？'))
                        return false;

                    // Get thjl datatable
                    var thjl_data = $('#thjl_datatable').DataTable().rows().data();
                    //    alert(table_rows_data.length);
                    //  alert(JSON.stringify(thjl_data));

                    var thjl_json = "";

                    for (var i = 0; i < thjl_data.length; i++) {
                        var tmp = thjl_data[i];
                        //  alert(JSON.stringify(tmp));
                        thjl_json = thjl_json + JSON.stringify(tmp) + ",";
                    }
                    thjl_json = "[" + thjl_json.substring(0, thjl_json.length - 1) + "]";
                    // alert(thjl_json);
                    // Get data 
                    var problem_data = $('#example').DataTable().rows().data();
                    //    alert(table_rows_data.length);
                    //  alert(JSON.stringify(problem_data));
                    var problem_data_json = "";
                    for (var i = 0; i < problem_data.length; i++) {
                        var tmp = problem_data[i];
                        problem_data_json = problem_data_json + JSON.stringify(tmp) + ",";

                    }
                    problem_data_json = "[" + problem_data_json.substring(0, problem_data_json.length - 1) + "]";
                    //   alert(problem_data_json);
                    var workdetail = $('#workdetail').val();

                    var flow_name = $("#wef_id").val();
                    $.ajax({
                        type: 'POST',
                        url: '/A7dot1dot1/ZzSubmit_submitsignal',
                        data: {
                            json1: '{"Thjl_data": ' + thjl_json
                                 + ', "Problem_data": ' + problem_data_json
                                 + ',"workdetail":"' + workdetail
                                 + '","Flow_Name":"' + flow_name
                                 + '","Cj_Name":"' + $('#cjname').find("option:selected").text()
                                 + '","Zz_Name":"' + $('#zzId').find("option:selected").text()
                                 + '","Equip_GyCode":"' + $('#Equip_GyCode').find("option:selected").text()
                                 + '","Equip_Code":"' + $('#E_Code').val()
                                 + '","Equip_Type":"' + $('#E_Type').val()                                       
                                 + '"}'

                            //json1: '{Flow_Name: "' + flow_name                         
                            //     + '", Cj_Name: "' + $('#cjname').find("option:selected").text()
                            //     + '", Zz_Name: "' + $('#zzId').find("option:selected").text()                        
                            //     + '", Equip_GyCode: "' + $('#Equip_GyCode').find("option:selected").text()
                            //     + '", Equip_Code: "' + $('#E_Code').val()
                            //     + '", Equip_Type: "' + $('#E_Type').val()
                            //     + '", Thjl_data: "' + thjl_json
                            //     + '", Problem_data": ' + problem_data_json
                            //     + '",workdetail":"' + workdetail
                            //     + '"}'
                        },
                        success: function (data) {
                            location.href = data;
                        },
                        error: function () {
                            alert('error');
                        }
                    });

                }

                function Thjl_selected() {
                    $('#thjl').show();

                    $('#thjl_datatable').DataTable({
                        "scrollX": false,
                        "scrollY": "30vh",
                        "scrollCollapse": true,
                        "paging": false,
                        "searching": false,
                        "info": false,
                        "ajax": {
                            "url": "/A7dot1dot1/Thjl_excel?thjl_id=1",
                            "dataSrc": ""
                        },
                        "columns": [
                            { "data": "name" },
                            { "data": "standard_value" },

                            {
                                "data": "exact_value"
                            }

                        ]
                    });

                    var table = $('#thjl_datatable').DataTable();

                    $('#thjl_datatable tbody').on('click', 'tr', function () {
                        //   alert("ddd");
                        if ($(this).hasClass('selected')) {
                            $(this).removeClass('selected');
                        }
                        else {
                            table.$('tr.selected').removeClass('selected');
                            $(this).addClass('selected');
                        }
                    });
                }

                function modify_row() {
                    $('#thjl_modal').modal('show');
                    $('#exact_value').val('');
                    var table_rows_data = $('#thjl_datatable').DataTable().row('.selected').data();
                    //  alert(table_rows_data.name);
                    //   alert(table_rows_data.standard_value);

                    $('#thjl_name').html(table_rows_data.name);

                    $('#standard_value').val(table_rows_data.standard_value);


                }

                function add_thjl_record() {
                    var thjl_name = $('#thjl_name').html();
                    var standard_value = $('#standard_value').val();
                    var exact_value = $('#exact_value').val();
                    var obj = { name: thjl_name, standard_value: standard_value, exact_value: exact_value };
                    $('#thjl_datatable').DataTable().row('.selected').data(obj);
                    $('#thjl_datatable').DataTable().rows().invalidate().draw();
                    $('#thjl_modal').modal('hide');
                }
            </script>


    <script>
        $(function () {
            //Initialize Select2 Elements
            $(".select2").select2();           
        });

        function list_Zz()
        {
            if ($('#cjname').val() != "") {
                $.ajax({
                    url: '/Common/Cj_Zzs',
                    dataType: 'json',
                    type: 'post',
                    data: { "cj_id": $('#cjname').val() },
                    success: function (backdata) {
                        if (backdata) {                   
                            var itemHtml = "<option value=\"\">" + "请选择" + "</option>";
                            for (var i = 0; i < backdata.length; i++) {
                                itemHtml = itemHtml + "<option value=\"" + backdata[i].Zz_Id + "\">" + backdata[i].Zz_Name + "</option>";
                            }                    
                            $('#zzId').html(itemHtml);
                        }
                        else
                        {
                            alert("error!!!");
                        }
                    }
                })
            }
        };

        function Zz_selected()
        {
            if ($('#zzId').val() != "") {
                $.ajax({
                    url: '/Common/Zz_Equips',
                    dataType: 'json',
                    type: 'post',
                    data: { "Zz_id": $('#zzId').val() },
                    success: function (backdata) {
                        if (backdata) {                            
                            var itemHtml = "<option value=\"\">" + "请选择" + "</option>";
                            for (var i = 0; i < backdata.length; i++) {
                                itemHtml = itemHtml + "<option value=\"" + backdata[i].Equip_Id + "\">" + backdata[i].Equip_GyCode + "</option>";
                            }
                            $('#Equip_GyCode').html(itemHtml);
                        }
                        else
                        {
                            alert("error!!!");
                        }
                    }
                })
            }
        };
        function Equip_selected() {
            if ($('#Equip_GyCode').val()!="") 
            { $.ajax({
                url: '/Common/ListEquip_Info',
                dataType: 'json',
                type: 'post',
                data: { "Equip_Id": $('#Equip_GyCode').val() },
                success: function (backdata) {
                    if (backdata) {
                        $("#E_Code").val(backdata[0].Equip_Code);
                        $("#E_Type").val(backdata[0].Equip_Type);

                        $("input:radio[name='zyoptionsRadiosinline']").each(function () {
                            $(this).val() == backdata[0].Equip_Specialty ? $(this).attr("checked", "checked") : null;
                        })

                        $("input:radio[name='subzyoptionsRadiosinline']").each(function () {
                            $(this).val() == backdata[0].Equip_PhaseB ? $(this).attr("checked", "checked") : null;
                        })
                    }
                    else
                    {
                        alert("error!!!");
                    }
                }
            }
            )
            }
        };

        function cancel_click() {
            if (!confirm('确定要取消吗？'))
                return false;

            var wef_id = $("#wef_id").val();
            var return_url = "/A7dot1/Index";
            $.ajax({
                type: 'POST',
                url: '/Common/CancelSubmit',
                data: {
                    json1: '{wef_id: "' + wef_id
                         + '", return_url: "' + return_url
                         + '"}'
                },
                success: function (data) {
                    location.href = data;
                },
                error: function () {
                    alert('error');
                }
            });
        };


    </script>
    }


 
 

