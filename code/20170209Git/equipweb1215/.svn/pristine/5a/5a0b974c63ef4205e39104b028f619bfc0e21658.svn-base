using EquipBLL.AdminManagment;
using EquipModel.Entities;
using FlowEngine;
using FlowEngine.UserInterface;
using Newtonsoft.Json;
using Newtonsoft.Json.Linq;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Web;
using System.Web.Mvc;

namespace WebApp.Controllers
{
    public class QueryController : Controller
    {
        //
        // GET: /Query/
        public class QueryModal
        {
          public  List<UI_WF_Define> wf;
          public List<Equip_Archi> UserHasEquips;

        }
      
        public ActionResult Index()
        {
            QueryModal qm=new QueryModal();
            qm.wf = CWFEngine.ListAllWFDefine();
            PersonManagment pm = new PersonManagment();
            qm.UserHasEquips = pm.Get_Person_Cj((Session["User"] as EquipModel.Entities.Person_Info).Person_Id);
            return View(qm);
        }


        public string Query_HistoryFlow(string time, string flow_id, string equip_gycode)//string json1)//,)
        {
         // JObject item = (JObject)JsonConvert.DeserializeObject(json1);
            List<object> r = new List<object>();
            if(time!="" || flow_id!="" || equip_gycode!="")
            {
                    string Equip_GyCode = equip_gycode;
                    string record_filter;

                    if (time == "")
                        record_filter = "1<>1";
                    else
                    {
                        string[] strtime = time.Split(new char[] { '-' });
                        record_filter = "time >= '" + strtime[0] + "00:00:00'" + "and  time <= '" + strtime[1] + " 00:00:00'";
                    }
               string Query_list = "E.W_Attribution,M.Miss_Desc,R.time,R.username,E.WE_Ser ";
               string Query_condition;
               if ((flow_id == "" && Equip_GyCode == ""))
                   Query_condition = "";
               else
               {
                   if (flow_id != "")
                   {
                       Query_condition = "E.W_Name like '%" + flow_id + "%'";
                       if (equip_gycode != "")
                           Query_condition = Query_condition + "  and P.Equip_Code like '%" + Equip_GyCode + "%'";
                   }
                   else
                       Query_condition = "P.Equip_Code like'%" + Equip_GyCode + "%'";
               }
           
              System.Data.DataTable dt = CWFEngine.QueryAllInformation(Query_list, Query_condition, record_filter);
           

            
            for(var i=0;i<dt.Rows.Count;i++)
            {
                object o = new
                {
                    index = i,
                    Mission_Name = dt.Rows[i].ItemArray[1].ToString(),
                    Flow_Name = "<a  onclick=\"DispalsySide('" + dt.Rows[i].ItemArray[4].ToString() + "')\"> " + dt.Rows[i].ItemArray[0].ToString() + "</a>",
                    Mission_Time = dt.Rows[i].ItemArray[2].ToString(),
                    Mission_User = dt.Rows[i].ItemArray[3].ToString(),
                   // Flow_Ser= dt.Rows[i].ItemArray[4].ToString()
                };
                r.Add(o);
            }
            }
            string str = JsonConvert.SerializeObject(r);
            return ("{" + "\"data\": " + str + "}");

        
        }
	}
}